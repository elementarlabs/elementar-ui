import {
  Component,
  OnInit,
  OnDestroy,
  ElementRef,
  forwardRef,
  inject,
  signal,
  computed,
  effect,
  model,
  input,
  InputSignal,
  ModelSignal,
  DestroyRef, viewChild, Renderer2, booleanAttribute,
} from '@angular/core';
import {
  ControlValueAccessor,
  NgControl,
  FormControl,
  ReactiveFormsModule,
} from '@angular/forms';
import { MatFormFieldControl } from '@angular/material/form-field';
import { MatOption, MatSelect, MatSelectChange, MatSelectTrigger } from '@angular/material/select';
import { Subject } from 'rxjs';
import { startWith } from 'rxjs/operators';
import { coerceBooleanProperty } from '@angular/cdk/coercion';
import { FocusMonitor } from '@angular/cdk/a11y';
import { toSignal } from '@angular/core/rxjs-interop';
import { Country } from '../country.interface';
import { MatIconButton } from '@angular/material/button';
import { MatIcon } from '@angular/material/icon';

@Component({
  selector: 'emr-country-select',
  exportAs: 'emrCountrySelect',
  templateUrl: './country-select.component.html',
  styleUrl: './country-select.component.scss',
  providers: [
    {
      provide: MatFormFieldControl,
      useExisting: forwardRef(() => CountrySelectComponent),
    },
  ],
  host: {
    'class': 'emr-country-select',
    '[class.floating]': 'shouldLabelFloat',
    '[id]': 'id',
  },
  imports: [
    MatOption,
    MatIcon,
    MatIconButton,
    MatSelect,
    MatSelectTrigger,
    ReactiveFormsModule
  ]
})
export class CountrySelectComponent
  implements
    OnInit,
    OnDestroy,
    ControlValueAccessor,
    MatFormFieldControl<string | null>
{
  private _elementRef = inject(ElementRef);
  private _renderer = inject(Renderer2);

  static nextId = 0;
  id = `emr-country-select-${CountrySelectComponent.nextId++}`;

  readonly stateChanges = new Subject<void>();
  controlType = 'emr-country-select';
  autofilled?: boolean;

  private readonly _valueSignal = signal<string | null>(null);
  private readonly _focusedSignal = signal(false);
  private _touched = false;

  placeholderInputSignal = input<string>('', { alias: 'placeholder' });
  isRequiredSignal = model<boolean>(false, { alias: 'required' });
  isDisabledSignal = model<boolean>(false, { alias: 'disabled' });

  readonly showCountryCode = input(false, {
    transform: booleanAttribute
  });

  readonly searchCtrl = new FormControl('');
  private readonly searchText = toSignal(this.searchCtrl.valueChanges.pipe(startWith('')), { initialValue: '' });

  readonly internalCountries: Country[] = [
    { "code": "af", "name": "Afghanistan", "flag": "ğŸ‡¦ğŸ‡«" },
    { "code": "ax", "name": "Ã…land Islands", "flag": "ğŸ‡¦ğŸ‡½" },
    { "code": "al", "name": "Albania", "flag": "ğŸ‡¦ğŸ‡±" },
    { "code": "dz", "name": "Algeria", "flag": "ğŸ‡©ğŸ‡¿" },
    { "code": "as", "name": "American Samoa", "flag": "ğŸ‡¦ğŸ‡¸" },
    { "code": "ad", "name": "Andorra", "flag": "ğŸ‡¦ğŸ‡©" },
    { "code": "ao", "name": "Angola", "flag": "ğŸ‡¦ğŸ‡´" },
    { "code": "ai", "name": "Anguilla", "flag": "ğŸ‡¦ğŸ‡®" },
    { "code": "aq", "name": "Antarctica", "flag": "ğŸ‡¦ğŸ‡¶" },
    { "code": "ag", "name": "Antigua and Barbuda", "flag": "ğŸ‡¦ğŸ‡¬" },
    { "code": "ar", "name": "Argentina", "flag": "ğŸ‡¦ğŸ‡·" },
    { "code": "am", "name": "Armenia", "flag": "ğŸ‡¦ğŸ‡²" },
    { "code": "aw", "name": "Aruba", "flag": "ğŸ‡¦ğŸ‡¼" },
    { "code": "au", "name": "Australia", "flag": "ğŸ‡¦ğŸ‡º" },
    { "code": "at", "name": "Austria", "flag": "ğŸ‡¦ğŸ‡¹" },
    { "code": "az", "name": "Azerbaijan", "flag": "ğŸ‡¦ğŸ‡¿" },
    { "code": "bs", "name": "Bahamas", "flag": "ğŸ‡§ğŸ‡¸" },
    { "code": "bh", "name": "Bahrain", "flag": "ğŸ‡§ğŸ‡­" },
    { "code": "bd", "name": "Bangladesh", "flag": "ğŸ‡§ğŸ‡©" },
    { "code": "bb", "name": "Barbados", "flag": "ğŸ‡§ğŸ‡§" },
    { "code": "by", "name": "Belarus", "flag": "ğŸ‡§ğŸ‡¾" },
    { "code": "be", "name": "Belgium", "flag": "ğŸ‡§ğŸ‡ª" },
    { "code": "bz", "name": "Belize", "flag": "ğŸ‡§ğŸ‡¿" },
    { "code": "bj", "name": "Benin", "flag": "ğŸ‡§ğŸ‡¯" },
    { "code": "bm", "name": "Bermuda", "flag": "ğŸ‡§ğŸ‡²" },
    { "code": "bt", "name": "Bhutan", "flag": "ğŸ‡§ğŸ‡¹" },
    { "code": "bo", "name": "Bolivia (Plurinational State of)", "flag": "ğŸ‡§ğŸ‡´" },
    { "code": "bq", "name": "Bonaire, Sint Eustatius and Saba", "flag": "ğŸ‡§ğŸ‡¶" },
    { "code": "ba", "name": "Bosnia and Herzegovina", "flag": "ğŸ‡§ğŸ‡¦" },
    { "code": "bw", "name": "Botswana", "flag": "ğŸ‡§ğŸ‡¼" },
    { "code": "bv", "name": "Bouvet Island", "flag": "ğŸ‡§ğŸ‡»" },
    { "code": "br", "name": "Brazil", "flag": "ğŸ‡§ğŸ‡·" },
    { "code": "io", "name": "British Indian Ocean Territory", "flag": "ğŸ‡®ğŸ‡´" },
    { "code": "bn", "name": "Brunei Darussalam", "flag": "ğŸ‡§ğŸ‡³" },
    { "code": "bg", "name": "Bulgaria", "flag": "ğŸ‡§ğŸ‡¬" },
    { "code": "bf", "name": "Burkina Faso", "flag": "ğŸ‡§ğŸ‡«" },
    { "code": "bi", "name": "Burundi", "flag": "ğŸ‡§ğŸ‡®" },
    { "code": "cv", "name": "Cabo Verde", "flag": "ğŸ‡¨ğŸ‡»" },
    { "code": "kh", "name": "Cambodia", "flag": "ğŸ‡°ğŸ‡­" },
    { "code": "cm", "name": "Cameroon", "flag": "ğŸ‡¨ğŸ‡²" },
    { "code": "ca", "name": "Canada", "flag": "ğŸ‡¨ğŸ‡¦" },
    { "code": "ky", "name": "Cayman Islands", "flag": "ğŸ‡°ğŸ‡¾" },
    { "code": "cf", "name": "Central African Republic", "flag": "ğŸ‡¨ğŸ‡«" },
    { "code": "td", "name": "Chad", "flag": "ğŸ‡¹ğŸ‡©" },
    { "code": "cl", "name": "Chile", "flag": "ğŸ‡¨ğŸ‡±" },
    { "code": "cn", "name": "China", "flag": "ğŸ‡¨ğŸ‡³" },
    { "code": "cx", "name": "Christmas Island", "flag": "ğŸ‡¨ğŸ‡½" },
    { "code": "cc", "name": "Cocos (Keeling) Islands", "flag": "ğŸ‡¨ğŸ‡¨" },
    { "code": "co", "name": "Colombia", "flag": "ğŸ‡¨ğŸ‡´" },
    { "code": "km", "name": "Comoros", "flag": "ğŸ‡°ğŸ‡²" },
    { "code": "cg", "name": "Congo", "flag": "ğŸ‡¨ğŸ‡¬" },
    { "code": "cd", "name": "Congo (Democratic Republic of the)", "flag": "ğŸ‡¨ğŸ‡©" },
    { "code": "ck", "name": "Cook Islands", "flag": "ğŸ‡¨ğŸ‡°" },
    { "code": "cr", "name": "Costa Rica", "flag": "ğŸ‡¨ğŸ‡·" },
    { "code": "ci", "name": "CÃ´te d'Ivoire", "flag": "ğŸ‡¨ğŸ‡®" },
    { "code": "hr", "name": "Croatia", "flag": "ğŸ‡­ğŸ‡·" },
    { "code": "cu", "name": "Cuba", "flag": "ğŸ‡¨ğŸ‡º" },
    { "code": "cw", "name": "CuraÃ§ao", "flag": "ğŸ‡¨ğŸ‡¼" },
    { "code": "cy", "name": "Cyprus", "flag": "ğŸ‡¨ğŸ‡¾" },
    { "code": "cz", "name": "Czechia", "flag": "ğŸ‡¨ğŸ‡¿" },
    { "code": "dk", "name": "Denmark", "flag": "ğŸ‡©ğŸ‡°" },
    { "code": "dj", "name": "Djibouti", "flag": "ğŸ‡©ğŸ‡¯" },
    { "code": "dm", "name": "Dominica", "flag": "ğŸ‡©ğŸ‡²" },
    { "code": "do", "name": "Dominican Republic", "flag": "ğŸ‡©ğŸ‡´" },
    { "code": "ec", "name": "Ecuador", "flag": "ğŸ‡ªğŸ‡¨" },
    { "code": "eg", "name": "Egypt", "flag": "ğŸ‡ªğŸ‡¬" },
    { "code": "sv", "name": "El Salvador", "flag": "ğŸ‡¸ğŸ‡»" },
    { "code": "gq", "name": "Equatorial Guinea", "flag": "ğŸ‡¬ğŸ‡¶" },
    { "code": "er", "name": "Eritrea", "flag": "ğŸ‡ªğŸ‡·" },
    { "code": "ee", "name": "Estonia", "flag": "ğŸ‡ªğŸ‡ª" },
    { "code": "sz", "name": "Eswatini", "flag": "ğŸ‡¸ğŸ‡¿" },
    { "code": "et", "name": "Ethiopia", "flag": "ğŸ‡ªğŸ‡¹" },
    { "code": "fk", "name": "Falkland Islands (Malvinas)", "flag": "ğŸ‡«ğŸ‡°" },
    { "code": "fo", "name": "Faroe Islands", "flag": "ğŸ‡«ğŸ‡´" },
    { "code": "fj", "name": "Fiji", "flag": "ğŸ‡«ğŸ‡¯" },
    { "code": "fi", "name": "Finland", "flag": "ğŸ‡«ğŸ‡®" },
    { "code": "fr", "name": "France", "flag": "ğŸ‡«ğŸ‡·" },
    { "code": "gf", "name": "French Guiana", "flag": "ğŸ‡¬ğŸ‡«" },
    { "code": "pf", "name": "French Polynesia", "flag": "ğŸ‡µğŸ‡«" },
    { "code": "tf", "name": "French Southern Territories", "flag": "ğŸ‡¹ğŸ‡«" },
    { "code": "ga", "name": "Gabon", "flag": "ğŸ‡¬ğŸ‡¦" },
    { "code": "gm", "name": "Gambia", "flag": "ğŸ‡¬ğŸ‡²" },
    { "code": "ge", "name": "Georgia", "flag": "ğŸ‡¬ğŸ‡ª" },
    { "code": "de", "name": "Germany", "flag": "ğŸ‡©ğŸ‡ª" },
    { "code": "gh", "name": "Ghana", "flag": "ğŸ‡¬ğŸ‡­" },
    { "code": "gi", "name": "Gibraltar", "flag": "ğŸ‡¬ğŸ‡®" },
    { "code": "gr", "name": "Greece", "flag": "ğŸ‡¬ğŸ‡·" },
    { "code": "gl", "name": "Greenland", "flag": "ğŸ‡¬ğŸ‡±" },
    { "code": "gd", "name": "Grenada", "flag": "ğŸ‡¬ğŸ‡©" },
    { "code": "gp", "name": "Guadeloupe", "flag": "ğŸ‡¬ğŸ‡µ" },
    { "code": "gu", "name": "Guam", "flag": "ğŸ‡¬ğŸ‡º" },
    { "code": "gt", "name": "Guatemala", "flag": "ğŸ‡¬ğŸ‡¹" },
    { "code": "gg", "name": "Guernsey", "flag": "ğŸ‡¬ğŸ‡¬" },
    { "code": "gn", "name": "Guinea", "flag": "ğŸ‡¬ğŸ‡³" },
    { "code": "gw", "name": "Guinea-Bissau", "flag": "ğŸ‡¬ğŸ‡¼" },
    { "code": "gy", "name": "Guyana", "flag": "ğŸ‡¬ğŸ‡¾" },
    { "code": "ht", "name": "Haiti", "flag": "ğŸ‡­ğŸ‡¹" },
    { "code": "hm", "name": "Heard Island and McDonald Islands", "flag": "ğŸ‡­ğŸ‡²" },
    { "code": "va", "name": "Holy See", "flag": "ğŸ‡»ğŸ‡¦" },
    { "code": "hn", "name": "Honduras", "flag": "ğŸ‡­ğŸ‡³" },
    { "code": "hk", "name": "Hong Kong", "flag": "ğŸ‡­ğŸ‡°" },
    { "code": "hu", "name": "Hungary", "flag": "ğŸ‡­ğŸ‡º" },
    { "code": "is", "name": "Iceland", "flag": "ğŸ‡®ğŸ‡¸" },
    { "code": "in", "name": "India", "flag": "ğŸ‡®ğŸ‡³" },
    { "code": "id", "name": "Indonesia", "flag": "ğŸ‡®ğŸ‡©" },
    { "code": "ir", "name": "Iran (Islamic Republic of)", "flag": "ğŸ‡®ğŸ‡·" },
    { "code": "iq", "name": "Iraq", "flag": "ğŸ‡®ğŸ‡¶" },
    { "code": "ie", "name": "Ireland", "flag": "ğŸ‡®ğŸ‡ª" },
    { "code": "im", "name": "Isle of Man", "flag": "ğŸ‡®ğŸ‡²" },
    { "code": "il", "name": "Israel", "flag": "ğŸ‡®ğŸ‡±" },
    { "code": "it", "name": "Italy", "flag": "ğŸ‡®ğŸ‡¹" },
    { "code": "jm", "name": "Jamaica", "flag": "ğŸ‡¯ğŸ‡²" },
    { "code": "jp", "name": "Japan", "flag": "ğŸ‡¯ğŸ‡µ" },
    { "code": "je", "name": "Jersey", "flag": "ğŸ‡¯ğŸ‡ª" },
    { "code": "jo", "name": "Jordan", "flag": "ğŸ‡¯ğŸ‡´" },
    { "code": "kz", "name": "Kazakhstan", "flag": "ğŸ‡°ğŸ‡¿" },
    { "code": "ke", "name": "Kenya", "flag": "ğŸ‡°ğŸ‡ª" },
    { "code": "ki", "name": "Kiribati", "flag": "ğŸ‡°ğŸ‡®" },
    { "code": "kp", "name": "Korea (Democratic People's Republic of)", "flag": "ğŸ‡°ğŸ‡µ" },
    { "code": "kr", "name": "Korea (Republic of)", "flag": "ğŸ‡°ğŸ‡·" },
    { "code": "kw", "name": "Kuwait", "flag": "ğŸ‡°ğŸ‡¼" },
    { "code": "kg", "name": "Kyrgyzstan", "flag": "ğŸ‡°ğŸ‡¬" },
    { "code": "la", "name": "Lao People's Democratic Republic", "flag": "ğŸ‡±ğŸ‡¦" },
    { "code": "lv", "name": "Latvia", "flag": "ğŸ‡±ğŸ‡»" },
    { "code": "lb", "name": "Lebanon", "flag": "ğŸ‡±ğŸ‡§" },
    { "code": "ls", "name": "Lesotho", "flag": "ğŸ‡±ğŸ‡¸" },
    { "code": "lr", "name": "Liberia", "flag": "ğŸ‡±ğŸ‡·" },
    { "code": "ly", "name": "Libya", "flag": "ğŸ‡±ğŸ‡¾" },
    { "code": "li", "name": "Liechtenstein", "flag": "ğŸ‡±ğŸ‡®" },
    { "code": "lt", "name": "Lithuania", "flag": "ğŸ‡±ğŸ‡¹" },
    { "code": "lu", "name": "Luxembourg", "flag": "ğŸ‡±ğŸ‡º" },
    { "code": "mo", "name": "Macao", "flag": "ğŸ‡²ğŸ‡´" },
    { "code": "mg", "name": "Madagascar", "flag": "ğŸ‡²ğŸ‡¬" },
    { "code": "mw", "name": "Malawi", "flag": "ğŸ‡²ğŸ‡¼" },
    { "code": "my", "name": "Malaysia", "flag": "ğŸ‡²ğŸ‡¾" },
    { "code": "mv", "name": "Maldives", "flag": "ğŸ‡²ğŸ‡»" },
    { "code": "ml", "name": "Mali", "flag": "ğŸ‡²ğŸ‡±" },
    { "code": "mt", "name": "Malta", "flag": "ğŸ‡²ğŸ‡¹" },
    { "code": "mh", "name": "Marshall Islands", "flag": "ğŸ‡²ğŸ‡­" },
    { "code": "mq", "name": "Martinique", "flag": "ğŸ‡²ğŸ‡¶" },
    { "code": "mr", "name": "Mauritania", "flag": "ğŸ‡²ğŸ‡·" },
    { "code": "mu", "name": "Mauritius", "flag": "ğŸ‡²ğŸ‡º" },
    { "code": "yt", "name": "Mayotte", "flag": "ğŸ‡¾ğŸ‡¹" },
    { "code": "mx", "name": "Mexico", "flag": "ğŸ‡²ğŸ‡½" },
    { "code": "fm", "name": "Micronesia (Federated States of)", "flag": "ğŸ‡«ğŸ‡²" },
    { "code": "md", "name": "Moldova (Republic of)", "flag": "ğŸ‡²ğŸ‡©" },
    { "code": "mc", "name": "Monaco", "flag": "ğŸ‡²ğŸ‡¨" },
    { "code": "mn", "name": "Mongolia", "flag": "ğŸ‡²ğŸ‡³" },
    { "code": "me", "name": "Montenegro", "flag": "ğŸ‡²ğŸ‡ª" },
    { "code": "ms", "name": "Montserrat", "flag": "ğŸ‡²ğŸ‡¸" },
    { "code": "ma", "name": "Morocco", "flag": "ğŸ‡²ğŸ‡¦" },
    { "code": "mz", "name": "Mozambique", "flag": "ğŸ‡²ğŸ‡¿" },
    { "code": "mm", "name": "Myanmar", "flag": "ğŸ‡²ğŸ‡²" },
    { "code": "na", "name": "Namibia", "flag": "ğŸ‡³ğŸ‡¦" },
    { "code": "nr", "name": "Nauru", "flag": "ğŸ‡³ğŸ‡·" },
    { "code": "np", "name": "Nepal", "flag": "ğŸ‡³ğŸ‡µ" },
    { "code": "nl", "name": "Netherlands", "flag": "ğŸ‡³ğŸ‡±" },
    { "code": "nc", "name": "New Caledonia", "flag": "ğŸ‡³ğŸ‡¨" },
    { "code": "nz", "name": "New Zealand", "flag": "ğŸ‡³ğŸ‡¿" },
    { "code": "ni", "name": "Nicaragua", "flag": "ğŸ‡³ğŸ‡®" },
    { "code": "ne", "name": "Niger", "flag": "ğŸ‡³ğŸ‡ª" },
    { "code": "ng", "name": "Nigeria", "flag": "ğŸ‡³ğŸ‡¬" },
    { "code": "nu", "name": "Niue", "flag": "ğŸ‡³ğŸ‡º" },
    { "code": "nf", "name": "Norfolk Island", "flag": "ğŸ‡³ğŸ‡«" },
    { "code": "mk", "name": "North Macedonia", "flag": "ğŸ‡²ğŸ‡°" },
    { "code": "mp", "name": "Northern Mariana Islands", "flag": "ğŸ‡²ğŸ‡µ" },
    { "code": "no", "name": "Norway", "flag": "ğŸ‡³ğŸ‡´" },
    { "code": "om", "name": "Oman", "flag": "ğŸ‡´ğŸ‡²" },
    { "code": "pk", "name": "Pakistan", "flag": "ğŸ‡µğŸ‡°" },
    { "code": "pw", "name": "Palau", "flag": "ğŸ‡µğŸ‡¼" },
    { "code": "ps", "name": "Palestine, State of", "flag": "ğŸ‡µğŸ‡¸" },
    { "code": "pa", "name": "Panama", "flag": "ğŸ‡µğŸ‡¦" },
    { "code": "pg", "name": "Papua New Guinea", "flag": "ğŸ‡µğŸ‡¬" },
    { "code": "py", "name": "Paraguay", "flag": "ğŸ‡µğŸ‡¾" },
    { "code": "pe", "name": "Peru", "flag": "ğŸ‡µğŸ‡ª" },
    { "code": "ph", "name": "Philippines", "flag": "ğŸ‡µğŸ‡­" },
    { "code": "pn", "name": "Pitcairn", "flag": "ğŸ‡µğŸ‡³" },
    { "code": "pl", "name": "Poland", "flag": "ğŸ‡µğŸ‡±" },
    { "code": "pt", "name": "Portugal", "flag": "ğŸ‡µğŸ‡¹" },
    { "code": "pr", "name": "Puerto Rico", "flag": "ğŸ‡µğŸ‡·" },
    { "code": "qa", "name": "Qatar", "flag": "ğŸ‡¶ğŸ‡¦" },
    { "code": "re", "name": "RÃ©union", "flag": "ğŸ‡·ğŸ‡ª" },
    { "code": "ro", "name": "Romania", "flag": "ğŸ‡·ğŸ‡´" },
    { "code": "ru", "name": "Russian Federation", "flag": "ğŸ‡·ğŸ‡º" },
    { "code": "rw", "name": "Rwanda", "flag": "ğŸ‡·ğŸ‡¼" },
    { "code": "bl", "name": "Saint BarthÃ©lemy", "flag": "ğŸ‡§ğŸ‡±" },
    { "code": "sh", "name": "Saint Helena, Ascension and Tristan da Cunha", "flag": "ğŸ‡¸ğŸ‡­" },
    { "code": "kn", "name": "Saint Kitts and Nevis", "flag": "ğŸ‡°ğŸ‡³" },
    { "code": "lc", "name": "Saint Lucia", "flag": "ğŸ‡±ğŸ‡¨" },
    { "code": "mf", "name": "Saint Martin (French part)", "flag": "ğŸ‡²ğŸ‡«" },
    { "code": "pm", "name": "Saint Pierre and Miquelon", "flag": "ğŸ‡µğŸ‡²" },
    { "code": "vc", "name": "Saint Vincent and the Grenadines", "flag": "ğŸ‡»ğŸ‡¨" },
    { "code": "ws", "name": "Samoa", "flag": "ğŸ‡¼ğŸ‡¸" },
    { "code": "sm", "name": "San Marino", "flag": "ğŸ‡¸ğŸ‡²" },
    { "code": "st", "name": "Sao Tome and Principe", "flag": "ğŸ‡¸ğŸ‡¹" },
    { "code": "sa", "name": "Saudi Arabia", "flag": "ğŸ‡¸ğŸ‡¦" },
    { "code": "sn", "name": "Senegal", "flag": "ğŸ‡¸ğŸ‡³" },
    { "code": "rs", "name": "Serbia", "flag": "ğŸ‡·ğŸ‡¸" },
    { "code": "sc", "name": "Seychelles", "flag": "ğŸ‡¸ğŸ‡¨" },
    { "code": "sl", "name": "Sierra Leone", "flag": "ğŸ‡¸ğŸ‡±" },
    { "code": "sg", "name": "Singapore", "flag": "ğŸ‡¸ğŸ‡¬" },
    { "code": "sx", "name": "Sint Maarten (Dutch part)", "flag": "ğŸ‡¸ğŸ‡½" },
    { "code": "sk", "name": "Slovakia", "flag": "ğŸ‡¸ğŸ‡°" },
    { "code": "si", "name": "Slovenia", "flag": "ğŸ‡¸ğŸ‡®" },
    { "code": "sb", "name": "Solomon Islands", "flag": "ğŸ‡¸ğŸ‡§" },
    { "code": "so", "name": "Somalia", "flag": "ğŸ‡¸ğŸ‡´" },
    { "code": "za", "name": "South Africa", "flag": "ğŸ‡¿ğŸ‡¦" },
    { "code": "gs", "name": "South Georgia and the South Sandwich Islands", "flag": "ğŸ‡¬ğŸ‡¸" },
    { "code": "ss", "name": "South Sudan", "flag": "ğŸ‡¸ğŸ‡¸" },
    { "code": "es", "name": "Spain", "flag": "ğŸ‡ªğŸ‡¸" },
    { "code": "lk", "name": "Sri Lanka", "flag": "ğŸ‡±ğŸ‡°" },
    { "code": "sd", "name": "Sudan", "flag": "ğŸ‡¸ğŸ‡©" },
    { "code": "sr", "name": "Suriname", "flag": "ğŸ‡¸ğŸ‡·" },
    { "code": "sj", "name": "Svalbard and Jan Mayen", "flag": "ğŸ‡¸ğŸ‡¯" },
    { "code": "se", "name": "Sweden", "flag": "ğŸ‡¸ğŸ‡ª" },
    { "code": "ch", "name": "Switzerland", "flag": "ğŸ‡¨ğŸ‡­" },
    { "code": "sy", "name": "Syrian Arab Republic", "flag": "ğŸ‡¸ğŸ‡¾" },
    { "code": "tw", "name": "Taiwan, Province of China", "flag": "ğŸ‡¹ğŸ‡¼" },
    { "code": "tj", "name": "Tajikistan", "flag": "ğŸ‡¹ğŸ‡¯" },
    { "code": "tz", "name": "Tanzania, United Republic of", "flag": "ğŸ‡¹ğŸ‡¿" },
    { "code": "th", "name": "Thailand", "flag": "ğŸ‡¹ğŸ‡­" },
    { "code": "tl", "name": "Timor-Leste", "flag": "ğŸ‡¹ğŸ‡±" },
    { "code": "tg", "name": "Togo", "flag": "ğŸ‡¹ğŸ‡¬" },
    { "code": "tk", "name": "Tokelau", "flag": "ğŸ‡¹ğŸ‡°" },
    { "code": "to", "name": "Tonga", "flag": "ğŸ‡¹ğŸ‡´" },
    { "code": "tt", "name": "Trinidad and Tobago", "flag": "ğŸ‡¹ğŸ‡¹" },
    { "code": "tn", "name": "Tunisia", "flag": "ğŸ‡¹ğŸ‡³" },
    { "code": "tr", "name": "Turkey", "flag": "ğŸ‡¹ğŸ‡·" },
    { "code": "tm", "name": "Turkmenistan", "flag": "ğŸ‡¹ğŸ‡²" },
    { "code": "tc", "name": "Turks and Caicos Islands", "flag": "ğŸ‡¹ğŸ‡¨" },
    { "code": "tv", "name": "Tuvalu", "flag": "ğŸ‡¹ğŸ‡»" },
    { "code": "ug", "name": "Uganda", "flag": "ğŸ‡ºğŸ‡¬" },
    { "code": "ua", "name": "Ukraine", "flag": "ğŸ‡ºğŸ‡¦" },
    { "code": "ae", "name": "United Arab Emirates", "flag": "ğŸ‡¦ğŸ‡ª" },
    { "code": "gb", "name": "United Kingdom of Great Britain and Northern Ireland", "flag": "ğŸ‡¬ğŸ‡§" },
    { "code": "us", "name": "United States of America", "flag": "ğŸ‡ºğŸ‡¸" },
    { "code": "um", "name": "United States Minor Outlying Islands", "flag": "ğŸ‡ºğŸ‡²" },
    { "code": "uy", "name": "Uruguay", "flag": "ğŸ‡ºğŸ‡¾" },
    { "code": "uz", "name": "Uzbekistan", "flag": "ğŸ‡ºğŸ‡¿" },
    { "code": "vu", "name": "Vanuatu", "flag": "ğŸ‡»ğŸ‡º" },
    { "code": "ve", "name": "Venezuela (Bolivarian Republic of)", "flag": "ğŸ‡»ğŸ‡ª" },
    { "code": "vn", "name": "Viet Nam", "flag": "ğŸ‡»ğŸ‡³" },
    { "code": "vg", "name": "Virgin Islands (British)", "flag": "ğŸ‡»ğŸ‡¬" },
    { "code": "vi", "name": "Virgin Islands (U.S.)", "flag": "ğŸ‡»ğŸ‡®" },
    { "code": "wf", "name": "Wallis and Futuna", "flag": "ğŸ‡¼ğŸ‡«" },
    { "code": "eh", "name": "Western Sahara", "flag": "ğŸ‡ªğŸ‡­" },
    { "code": "ye", "name": "Yemen", "flag": "ğŸ‡¾ğŸ‡ª" },
    { "code": "zm", "name": "Zambia", "flag": "ğŸ‡¿ğŸ‡²" },
    { "code": "zw", "name": "Zimbabwe", "flag": "ğŸ‡¿ğŸ‡¼" }
  ];

  readonly filteredCountries = computed(() => this._filterCountries(this.searchText()));
  readonly selectedCountryDisplay = computed(() => {
    return this.internalCountries.find(c => c.code === this._valueSignal());
  });

  readonly matSelect = viewChild.required<MatSelect>('matSelect');
  readonly searchInput = viewChild.required<ElementRef<HTMLInputElement>>('searchInput');

  private readonly fm = inject(FocusMonitor);
  private readonly elRef = inject<ElementRef<HTMLElement>>(ElementRef);
  public readonly ngControl = inject(NgControl, { self: true, optional: true });
  private readonly destroyRef = inject(DestroyRef);

  private onChangeFn: (value: string | null) => void = () => {};
  private onTouchedFn: () => void = () => {};

  constructor() {
    if (this.ngControl) {
      this.ngControl.valueAccessor = this;
    }

    this.destroyRef.onDestroy(() => {
      this.fm.stopMonitoring(this.elRef.nativeElement);
      this.stateChanges.complete();
    });

    effect(() => {
      this.onChangeFn(this._valueSignal());
    });

    effect(() => {
      this._valueSignal();
      this._focusedSignal();
      this.isRequiredSignal();
      this.isDisabledSignal();
      this.placeholderInputSignal();
      this.ngControl?.control?.status;
      this.stateChanges.next();
    });

    effect(() => {
      if (this.isDisabledSignal()) {
        this.searchCtrl.disable({ emitEvent: false });
      } else {
        this.searchCtrl.enable({ emitEvent: false });
      }
    });
  }

  ngOnInit(): void {
    if (this.ngControl?.control) {
      const control = this.ngControl.control;

      if (control.validator) {
        const validator = control.validator({} as any);
        if (validator && validator['required']) {
          this.isRequiredSignal.set(true);
        }
      }

      this.isDisabledSignal.set(control.disabled);
    }

    const formFieldElement = this._elementRef.nativeElement.closest('.mat-mdc-form-field');

    if (formFieldElement) {
      this._renderer.addClass(formFieldElement, 'mat-mdc-form-field-type-mat-select');
    }
  }

  ngOnDestroy(): void {
  }

  get value(): string | null {
    return this._valueSignal();
  }
  set value(val: string | null) {
    this._valueSignal.set(val);
  }

  get focused(): boolean {
    return this._focusedSignal();
  }

  get placeholder(): string {
    return this.placeholderInputSignal();
  }
  set placeholder(plh: string) {
    this.stateChanges.next();
  }

  get required(): boolean {
    return this.isRequiredSignal();
  }
  set required(req: boolean) {
    this.isRequiredSignal.set(coerceBooleanProperty(req));
  }

  get disabled(): boolean {
    return this.isDisabledSignal();
  }
  set disabled(dis: boolean) {
    this.isDisabledSignal.set(coerceBooleanProperty(dis));
  }

  get empty(): boolean {
    return !this._valueSignal();
  }

  get shouldLabelFloat(): boolean {
    return this._focusedSignal() || !this.empty;
  }

  get errorState(): boolean {
    return !!(this.ngControl?.invalid && (this.ngControl?.touched || this._touched));
  }

  get touched(): boolean {
    return this._touched;
  }

  setDescribedByIds(ids: string[]): void {
    const controlElement = this.elRef.nativeElement.querySelector('.select-trigger');

    if (controlElement) {
      controlElement.setAttribute('aria-describedby', ids.join(' '));
    }
  }

  onContainerClick(): void {
    if (this.disabled) {
      return;
    }

    this._focusedSignal.set(true);
    this.matSelect().onContainerClick();
  }

  writeValue(value: string | null): void {
    this._valueSignal.set(value);
  }

  registerOnChange(fn: any): void {
    this.onChangeFn = fn;
  }

  registerOnTouched(fn: any): void {
    this.onTouchedFn = () => {
      this._touched = true;
      fn();
      this.stateChanges.next();
    };
  }

  setDisabledState(isDisabled: boolean): void {
    this.disabled = isDisabled;
  }

  private _filterCountries(searchText: string | null): Country[] {
    const filterValue = (searchText || '').toLowerCase();
    if (!filterValue) {
      return [...this.internalCountries];
    }
    return this.internalCountries.filter((country) =>
      country.name.toLowerCase().includes(filterValue) ||
      country.code.toLowerCase().includes(filterValue)
    );
  }

  onSelectionChange(event: MatSelectChange): void {
    this.value = event.value;
    this.onTouchedFn();
  }

  clearSearch(event: MouseEvent): void {
    event.stopPropagation();
    this.searchCtrl.setValue('');
    this.searchInput().nativeElement.focus();
  }

  onSelectOpened(): void {
    setTimeout(() => {
      this.searchInput().nativeElement.focus();
    });
  }

  onSelectClosed(): void {
    this._focusedSignal.set(false);
    this.searchCtrl.setValue('');

    if (!this._touched) {
      this.onTouchedFn();
    }
  }
}
